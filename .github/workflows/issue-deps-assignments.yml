name: Issue dependency assignment (Nexoroid)

on:
  issues:
    types: [closed, reopened, edited]

permissions:
  contents: read
  issues: write

env:
  # Optional fallback assignee when an unblocked issue has none
  DEFAULT_ASSIGNEE: "smcnab1"

jobs:
  issue-deps:
    if: ${{ github.event.issue.pull_request == null }}
    runs-on: ubuntu-latest

    steps:
      - name: Create Nexoroid installation token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.NEXOROID_APP_ID }}
          private-key: ${{ secrets.NEXOROID_APP_PRIVATE_KEY }}

      - name: Install tools
        run: sudo apt-get update && sudo apt-get install -y jq

      # ── A) Closed → assign dependants & remove 'blocked' ───────────────────────
      - name: Closed → assign dependants & remove 'blocked'
        if: ${{ github.event.action == 'closed' }}
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
          DEFAULT_ASSIGNEE: ${{ env.DEFAULT_ASSIGNEE }}
        run: |
          set -euo pipefail
          owner="${GITHUB_REPOSITORY%/*}"
          repo="${GITHUB_REPOSITORY#*/}"
          src="${{ github.event.issue.number }}"

          gh api -H 'X-GitHub-Api-Version: 2022-11-28' \
            "/repos/$owner/$repo/issues/$src/dependencies/blocking" \
            | jq -c '.[]' > /tmp/dependants.json || true

          CLOSED_COUNT="$(wc -l < /tmp/dependants.json || true)"
          echo "CLOSED_COUNT=$CLOSED_COUNT" >> "$GITHUB_ENV"

          while IFS= read -r row; do
            num="$(jq -r '.number' <<< "$row")"
            state="$(jq -r '.state'  <<< "$row")"
            [ "$state" = "open" ] || { echo "#$num not open; skip"; continue; }

            issue_json="$(gh api -H 'X-GitHub-Api-Version: 2022-11-28' "/repos/$owner/$repo/issues/$num")"
            assignee_count="$(jq '.assignees | length' <<< "$issue_json")"
            author="$(jq -r '.user.login' <<< "$issue_json")"

            if [ "$assignee_count" -gt 0 ]; then
              echo "#$num already has assignees; skipping"
            else
              target="${DEFAULT_ASSIGNEE:-$author}"
              echo "Assigning @$target to #$num"
              gh api -X POST -H 'X-GitHub-Api-Version: 2022-11-28' \
                "/repos/$owner/$repo/issues/$num/assignees" -f "assignees[]=$target"

              gh api -X POST -H 'X-GitHub-Api-Version: 2022-11-28' \
                "/repos/$owner/$repo/issues/$num/comments" \
                -f body="Unblocked by #$src (now closed). Assigned to @$target. ✅"
            fi

            # Remove 'blocked' label if present
            gh api -X DELETE -H 'X-GitHub-Api-Version: 2022-11-28' \
              "/repos/$owner/$repo/issues/$num/labels/blocked" || true
          done < /tmp/dependants.json

      # ── B) Reopened → unassign dependants & add 'blocked' ──────────────────────
      - name: Reopened → unassign dependants & add 'blocked'
        if: ${{ github.event.action == 'reopened' }}
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          set -euo pipefail
          owner="${GITHUB_REPOSITORY%/*}"
          repo="${GITHUB_REPOSITORY#*/}"
          src="${{ github.event.issue.number }}"

          gh api -H 'X-GitHub-Api-Version: 2022-11-28' \
            "/repos/$owner/$repo/issues/$src/dependencies/blocking" \
            | jq -c '.[]' > /tmp/reblocked.json || true

          REOPENED_COUNT="$(wc -l < /tmp/reblocked.json || true)"
          echo "REOPENED_COUNT=$REOPENED_COUNT" >> "$GITHUB_ENV"

          while IFS= read -r row; do
            num="$(jq -r '.number' <<< "$row")"
            state="$(jq -r '.state'  <<< "$row")"
            [ "$state" = "open" ] || { echo "#$num not open; skip"; continue; }

            issue_json="$(gh api -H 'X-GitHub-Api-Version: 2022-11-28' "/repos/$owner/$repo/issues/$num")"

            # Unassign everyone (nil-safe)
            jq -r '.assignees[]?.login // empty' <<< "$issue_json" | while read -r u; do
              [ -n "${u:-}" ] || continue
              echo "Unassigning @$u from #$num"
              gh api -X DELETE -H 'X-GitHub-Api-Version: 2022-11-28' \
                "/repos/$owner/$repo/issues/$num/assignees" -f "assignees[]=$u" || true
            done

            # Add 'blocked' label (idempotent)
            gh api -X POST -H 'X-GitHub-Api-Version: 2022-11-28' \
              "/repos/$owner/$repo/issues/$num/labels" -f "labels[]=blocked" || true

            gh api -X POST -H 'X-GitHub-Api-Version: 2022-11-28' \
              "/repos/$owner/$repo/issues/$num/comments" \
              -f body="Re-blocked by #$src (reopened). All assignees removed and label applied. ⛔"
          done < /tmp/reblocked.json

      # ── C) Edited → if now blocked, unassign itself & add 'blocked' ────────────
      - name: Edited → enforce blocked state on this issue
        if: ${{ github.event.action == 'edited' }}
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          set -euo pipefail
          owner="${GITHUB_REPOSITORY%/*}"
          repo="${GITHUB_REPOSITORY#*/}"
          num="${{ github.event.issue.number }}"

          gh api -H 'X-GitHub-Api-Version: 2022-11-28' \
            "/repos/$owner/$repo/issues/$num/dependencies/blocked_by" \
            | jq -c '[.[] | select(.state=="open")]' > /tmp/open_blockers.json || echo "[]" > /tmp/open_blockers.json

          EDITED_OPEN_BLOCKERS="$(jq 'length' /tmp/open_blockers.json)"
          echo "EDITED_OPEN_BLOCKERS=$EDITED_OPEN_BLOCKERS" >> "$GITHUB_ENV"

          if [ "$EDITED_OPEN_BLOCKERS" -gt 0 ]; then
            issue_json="$(gh api -H 'X-GitHub-Api-Version: 2022-11-28' "/repos/$owner/$repo/issues/$num")"

            # Unassign everyone
            jq -r '.assignees[]?.login // empty' <<< "$issue_json" | while read -r u; do
              [ -n "${u:-}" ] || continue
              echo "Unassigning @$u from #$num"
              gh api -X DELETE -H 'X-GitHub-Api-Version: 2022-11-28' \
                "/repos/$owner/$repo/issues/$num/assignees" -f "assignees[]=$u" || true
            done

            # Add 'blocked' label (idempotent)
            gh api -X POST -H 'X-GitHub-Api-Version: 2022-11-28' \
              "/repos/$owner/$repo/issues/$num/labels" -f "labels[]=blocked" || true

            gh api -X POST -H 'X-GitHub-Api-Version: 2022-11-28' \
              "/repos/$owner/$repo/issues/$num/comments" \
              -f body="This issue is currently **blocked** by at least one open dependency. Assignees removed and label applied. ⛔"
          else
            echo "No open blockers after edit; nothing to enforce."
          fi

      - name: Job summary
        run: |
          {
            echo "### Issue dependency assignment (Nexoroid)"
            echo "- Action: ${{ github.event.action }}"
            echo "- Closed dependants processed: ${CLOSED_COUNT:-0}"
            echo "- Reopened dependants processed: ${REOPENED_COUNT:-0}"
            echo "- Edited open blockers: ${EDITED_OPEN_BLOCKERS:-0}"
          } >> "$GITHUB_STEP_SUMMARY"
